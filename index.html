<!doctype html>
<html lang="en" class="min-h-screen">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>CeX Stock Tracker</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: "#00d9ff",
                            success: "#00ff88",
                        },
                    },
                },
            };
        </script>
        <style>
            body {
                background: linear-gradient(135deg, #0a0e27 0%, #16213e 100%);
                background-attachment: fixed;
            }
        </style>
    </head>
    <body class="min-h-screen text-gray-100">
        <div class="px-6 py-8">
            <!-- Simple compact header -->
            <div class="mb-8 flex items-center justify-center gap-4">
                <input
                    type="text"
                    id="storeSearch"
                    class="bg-slate-800/50 border border-cyan-500/30 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 transition-all w-96"
                    placeholder="Search stores..."
                    autocomplete="off"
                />
                <button
                    id="sortBtn"
                    class="bg-slate-800/50 border border-cyan-500/30 rounded-xl px-4 py-3 text-sm font-medium hover:bg-cyan-500/10 hover:border-cyan-500 transition-all whitespace-nowrap"
                >
                    Sort by Distance
                </button>
                <div
                    id="storeDropdown"
                    class="hidden absolute top-full mt-2 bg-slate-800 border border-cyan-500/30 rounded-xl shadow-2xl max-h-80 overflow-y-auto z-50 w-96"
                ></div>
            </div>

            <!-- Grid of cards -->
            <div
                id="grid"
                class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-7 2xl:grid-cols-10 gap-6"
            ></div>
        </div>

        <!-- Modal -->
        <div
            id="modalOverlay"
            class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"
        >
            <div
                class="bg-slate-800 rounded-2xl border border-cyan-500/30 shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden"
            >
                <div
                    class="flex items-center justify-between p-6 border-b border-slate-700"
                >
                    <h2
                        id="modalTitle"
                        class="text-xl font-bold text-white"
                    ></h2>
                    <button
                        id="modalClose"
                        class="w-8 h-8 rounded-lg bg-slate-700 hover:bg-red-500/20 hover:text-red-400 transition-colors flex items-center justify-center text-2xl"
                    >
                        Ã—
                    </button>
                </div>
                <div
                    id="modalBody"
                    class="p-6 overflow-y-auto max-h-[60vh]"
                ></div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div
            id="loadingOverlay"
            class="fixed inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 z-50 flex flex-col items-center justify-center transition-opacity duration-300"
        >
            <div class="relative">
                <div
                    class="w-20 h-20 border-4 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin"
                ></div>
                <div
                    class="absolute inset-0 w-20 h-20 border-4 border-transparent border-r-blue-500 rounded-full animate-spin"
                    style="
                        animation-duration: 1.5s;
                        animation-direction: reverse;
                    "
                ></div>
            </div>
            <div class="mt-6 text-cyan-400 font-semibold text-lg animate-pulse">
                Loading CeX Products...
            </div>
        </div>

        <script>
            let selectedStore = null;
            let allStores = [];
            let sortByDistance = false;
            let productsData = []; // Store products with their data for sorting

            // Simple list of links - SKU is extracted automatically from URL
            const products = [
                "https://uk.webuy.com/product-detail/?id=5039036082563",
                "https://uk.webuy.com/product-detail?id=5030697044006",
                "https://uk.webuy.com/product-detail?id=5039036081054",
                "https://uk.webuy.com/product-detail?id=5017239120039",
                "https://uk.webuy.com/product-detail?id=5039036074162",
                "https://uk.webuy.com/product-detail?id=5051892255448",
                "https://uk.webuy.com/product-detail?id=5039036060486",
                "https://uk.webuy.com/product-detail?id=5060797576411",
                "https://uk.webuy.com/product-detail?id=5061049330256",
                "https://uk.webuy.com/product-detail?id=5060223761633S",
                "https://uk.webuy.com/product-detail?id=5030930048341",
                "https://uk.webuy.com/product-detail?id=5053083202743",
                "https://uk.webuy.com/product-detail?id=7321900183215",
                "https://uk.webuy.com/product-detail?id=5050582805895",
                "https://uk.webuy.com/product-detail?id=5053083268640",
                "https://uk.webuy.com/product-detail?id=8717418365899",
                "https://uk.webuy.com/product-detail?id=5051892228855",
                "https://uk.webuy.com/product-detail/?id=5055761916881",
                "https://uk.webuy.com/product-detail/?id=5060952890550",
                "https://uk.webuy.com/product-detail/?id=5060952890567",
            ];

            function extractSkuFromUrl(url) {
                const match = url.match(/[?&]id=([^&]+)/);
                return match ? match[1] : null;
            }

            function isSearchUrl(url) {
                return url.includes("/search?");
            }

            function getSearchTitle(url) {
                const match = url.match(/stext=([^&]+)/);
                if (match) {
                    const searchTerm = decodeURIComponent(
                        match[1].replace(/\+/g, " "),
                    );
                    return `Search: ${searchTerm}`;
                }
                return "Search";
            }

            async function fetchProductDetails(sku) {
                if (!sku) return null;
                try {
                    const apiUrl = `https://corsproxy.io/?https://wss2.cex.uk.webuy.io/v3/boxes/${sku}/detail`;
                    const resp = await fetch(apiUrl);
                    if (!resp.ok) return null;
                    const json = await resp.json();
                    return json?.response?.data?.boxDetails?.[0] ?? null;
                } catch (e) {
                    console.error("Error fetching details for SKU", sku, e);
                    return null;
                }
            }

            async function fetchAllStores() {
                try {
                    const apiUrl = `https://corsproxy.io/?https://wss2.cex.uk.webuy.io/v3/stores`;
                    const resp = await fetch(apiUrl);
                    if (!resp.ok) return [];
                    const json = await resp.json();
                    const stores = json?.response?.data?.stores ?? [];
                    return stores.sort((a, b) =>
                        a.storeName.localeCompare(b.storeName),
                    );
                } catch (e) {
                    console.error("Error fetching stores", e);
                    return [];
                }
            }

            async function fetchNearestStores(sku) {
                if (!sku) return null;
                try {
                    let lat, lon;
                    if (selectedStore) {
                        lat = selectedStore.latitude;
                        lon = selectedStore.longitude;
                    } else {
                        lat = 53.52228;
                        lon = -1.13534;
                    }

                    const apiUrl = `https://corsproxy.io/?https://wss2.cex.uk.webuy.io/v3/boxes/${sku}/neareststores?latitude=${lat}&longitude=${lon}`;
                    const resp = await fetch(apiUrl);
                    if (!resp.ok) return null;
                    const json = await resp.json();
                    return json?.response?.data?.nearestStores ?? [];
                } catch (e) {
                    console.error(
                        "Error fetching nearest stores for SKU",
                        sku,
                        e,
                    );
                    return [];
                }
            }

            function getLocationName() {
                if (selectedStore) {
                    return selectedStore.storeName;
                } else {
                    return "Doncaster";
                }
            }

            function kmToMiles(km) {
                return km * 0.621371;
            }

            function showLoading() {
                const loadingOverlay =
                    document.getElementById("loadingOverlay");
                loadingOverlay.classList.remove("hidden", "opacity-0");
            }

            function hideLoading() {
                const loadingOverlay =
                    document.getElementById("loadingOverlay");
                loadingOverlay.classList.add("opacity-0");
                setTimeout(() => {
                    loadingOverlay.classList.add("hidden");
                }, 300);
            }

            function showStoresModal(productTitle, stores) {
                const modalOverlay = document.getElementById("modalOverlay");
                const modalTitle = document.getElementById("modalTitle");
                const modalBody = document.getElementById("modalBody");
                const modalClose = document.getElementById("modalClose");

                modalTitle.textContent = productTitle;
                modalBody.innerHTML = "";

                const locationName = getLocationName();

                stores.forEach((store) => {
                    const storeItem = document.createElement("div");
                    storeItem.className =
                        "p-4 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition-colors";

                    const storeName = document.createElement("div");
                    // Highlight in yellow if it matches the selected store
                    const isSelectedStore =
                        selectedStore &&
                        store.storeName === selectedStore.storeName;
                    storeName.className = isSelectedStore
                        ? "font-semibold text-yellow-400 mb-2"
                        : "font-semibold text-white mb-2";
                    storeName.textContent = store.storeName;
                    storeItem.appendChild(storeName);

                    const storeDetails = document.createElement("div");
                    storeDetails.className = "flex gap-4 text-sm";

                    const stock = document.createElement("span");
                    stock.className = "text-green-400 font-semibold";
                    stock.textContent = `${store.quantityOnHand} in stock`;
                    storeDetails.appendChild(stock);

                    const distance = document.createElement("span");
                    distance.className = "text-cyan-400";
                    const miles = kmToMiles(store.distance);
                    distance.textContent = `${miles.toFixed(1)} mi from ${locationName}`;
                    storeDetails.appendChild(distance);

                    storeItem.appendChild(storeDetails);
                    modalBody.appendChild(storeItem);
                });

                modalOverlay.classList.remove("hidden");

                const closeModal = () => {
                    modalOverlay.classList.add("hidden");
                };

                modalClose.onclick = closeModal;
                modalOverlay.onclick = (e) => {
                    if (e.target === modalOverlay) {
                        closeModal();
                    }
                };

                document.addEventListener("keydown", function onEscape(e) {
                    if (e.key === "Escape") {
                        closeModal();
                        document.removeEventListener("keydown", onEscape);
                    }
                });
            }

            function loadPreferences() {
                const saved = localStorage.getItem("cexStorePreference");
                if (saved) {
                    try {
                        const prefs = JSON.parse(saved);
                        if (prefs.type === "store" && prefs.storeId) {
                            return prefs;
                        }
                    } catch (e) {
                        console.error("Error loading preferences", e);
                    }
                }
                return null;
            }

            function savePreferences(type, data) {
                const prefs = { type, ...data };
                localStorage.setItem(
                    "cexStorePreference",
                    JSON.stringify(prefs),
                );
            }

            function renderStoreDropdown(filterText = "") {
                const dropdown = document.getElementById("storeDropdown");
                dropdown.innerHTML = "";

                const filtered = allStores.filter((store) =>
                    store.storeName
                        .toLowerCase()
                        .includes(filterText.toLowerCase()),
                );

                if (filtered.length === 0) {
                    const noResults = document.createElement("div");
                    noResults.className =
                        "p-3 text-center text-gray-400 text-sm";
                    noResults.textContent = "No stores found";
                    dropdown.appendChild(noResults);
                    return;
                }

                filtered.forEach((store) => {
                    const option = document.createElement("div");
                    option.className =
                        "px-4 py-3 cursor-pointer hover:bg-cyan-500/10 hover:text-cyan-400 transition-colors text-sm font-medium";

                    if (
                        selectedStore &&
                        selectedStore.storeId === store.storeId
                    ) {
                        option.className += " bg-green-500/10 text-green-400";
                    }

                    option.textContent = store.storeName;
                    option.dataset.storeId = store.storeId;

                    option.addEventListener("click", async () => {
                        selectedStore = store;
                        document.getElementById("storeSearch").value =
                            store.storeName;
                        document
                            .getElementById("storeDropdown")
                            .classList.add("hidden");
                        savePreferences("store", { storeId: store.storeId });
                        await reloadProducts();
                    });

                    dropdown.appendChild(option);
                });
            }

            async function initStoreSelector() {
                allStores = await fetchAllStores();
                const searchInput = document.getElementById("storeSearch");
                const dropdown = document.getElementById("storeDropdown");
                let selectedIndex = -1;

                const prefs = loadPreferences();
                if (prefs && prefs.type === "store") {
                    selectedStore = allStores.find(
                        (s) => s.storeId === prefs.storeId,
                    );
                    if (selectedStore) {
                        searchInput.value = selectedStore.storeName;
                    }
                } else {
                    // Set default to Doncaster
                    selectedStore = allStores.find(
                        (s) => s.storeName === "Doncaster",
                    );
                    if (selectedStore) {
                        searchInput.value = selectedStore.storeName;
                    } else {
                        searchInput.value = "Doncaster";
                    }
                }

                searchInput.addEventListener("input", (e) => {
                    selectedIndex = -1;
                    renderStoreDropdown(e.target.value);
                    dropdown.classList.remove("hidden");
                    dropdown.style.width = searchInput.offsetWidth + "px";
                });

                searchInput.addEventListener("focus", () => {
                    renderStoreDropdown(searchInput.value);
                    dropdown.classList.remove("hidden");
                    dropdown.style.width = searchInput.offsetWidth + "px";
                    dropdown.style.left = searchInput.offsetLeft + "px";
                    dropdown.style.top =
                        searchInput.offsetTop +
                        searchInput.offsetHeight +
                        8 +
                        "px";
                });

                searchInput.addEventListener("keydown", (e) => {
                    const options =
                        dropdown.querySelectorAll("div[data-store-id]");

                    if (e.key === "ArrowDown") {
                        e.preventDefault();
                        selectedIndex = Math.min(
                            selectedIndex + 1,
                            options.length - 1,
                        );
                        updateSelectedOption(options, selectedIndex);
                    } else if (e.key === "ArrowUp") {
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, -1);
                        updateSelectedOption(options, selectedIndex);
                    } else if (e.key === "Enter" && selectedIndex >= 0) {
                        e.preventDefault();
                        options[selectedIndex].click();
                    } else if (e.key === "Escape") {
                        dropdown.classList.add("hidden");
                        searchInput.blur();
                    }
                });

                function updateSelectedOption(options, index) {
                    options.forEach((opt, i) => {
                        if (i === index) {
                            opt.classList.add("bg-cyan-500/20");
                            opt.scrollIntoView({ block: "nearest" });
                        } else {
                            opt.classList.remove("bg-cyan-500/20");
                        }
                    });
                }

                document.addEventListener("click", (e) => {
                    if (
                        !searchInput.contains(e.target) &&
                        !dropdown.contains(e.target)
                    ) {
                        dropdown.classList.add("hidden");
                    }
                });
            }

            async function reloadProducts() {
                showLoading();
                const grid = document.getElementById("grid");
                grid.innerHTML = "";
                await loadProducts();
                hideLoading();
            }

            async function loadProducts() {
                const grid = document.getElementById("grid");
                productsData = [];

                // Fetch all product data first
                for (const url of products) {
                    const sku = extractSkuFromUrl(url);
                    const isSearch = isSearchUrl(url);

                    const detail = isSearch
                        ? null
                        : await fetchProductDetails(sku);
                    const stores = isSearch
                        ? []
                        : await fetchNearestStores(sku);

                    const imgUrl = detail?.imageUrls?.medium;
                    const title = isSearch
                        ? getSearchTitle(url)
                        : (detail?.boxName ?? `Product ${sku}`);
                    const category =
                        detail?.categoryName?.replace(/-/g, " ") ??
                        (isSearch ? "SEARCH" : "PRODUCT");
                    const price = detail?.sellPrice;
                    const nearestDistance =
                        stores && stores.length > 0
                            ? stores[0].distance
                            : Infinity;

                    productsData.push({
                        url,
                        sku,
                        isSearch,
                        detail,
                        stores,
                        imgUrl,
                        title,
                        category,
                        price,
                        nearestDistance,
                    });
                }

                // Sort if enabled
                if (sortByDistance) {
                    productsData.sort(
                        (a, b) => a.nearestDistance - b.nearestDistance,
                    );
                }

                // Render all products
                for (const productData of productsData) {
                    const { url, stores, imgUrl, title, category, price } =
                        productData;

                    // Create card with Tailwind classes
                    const card = document.createElement("a");
                    card.href = url;
                    card.target = "_blank";
                    card.rel = "noopener";
                    card.className =
                        "group block bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-2xl overflow-hidden hover:border-cyan-500/50 hover:shadow-xl hover:shadow-cyan-500/20 hover:-translate-y-2 hover:scale-[1.02] transition-all duration-300";

                    // Image section
                    const imageDiv = document.createElement("div");
                    imageDiv.className =
                        "relative h-64 bg-gradient-to-br from-slate-700 to-slate-900 flex items-center justify-center overflow-hidden";

                    const img = document.createElement("img");
                    img.src =
                        imgUrl ||
                        "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='40' fill='%23475569'%3EðŸ“¦%3C/text%3E%3C/svg%3E";
                    img.className =
                        "max-w-[90%] max-h-[90%] object-contain drop-shadow-2xl";
                    imageDiv.appendChild(img);

                    card.appendChild(imageDiv);

                    // Body section
                    const bodyDiv = document.createElement("div");
                    bodyDiv.className = "p-3";

                    // Category and price row
                    const topRow = document.createElement("div");
                    topRow.className =
                        "flex items-center justify-between gap-2 mb-2";

                    const badge = document.createElement("div");
                    badge.className =
                        "inline-block bg-gradient-to-r from-cyan-500 to-blue-500 text-slate-900 px-2 py-0.5 rounded-md text-xs font-bold uppercase tracking-wider";
                    badge.textContent = category;
                    topRow.appendChild(badge);

                    if (price) {
                        const priceTag = document.createElement("div");
                        priceTag.className =
                            "bg-red-900 text-white px-2 py-0.5 rounded-md text-xs font-bold";
                        priceTag.textContent = `Â£${price}`;
                        topRow.appendChild(priceTag);
                    }

                    bodyDiv.appendChild(topRow);

                    // Title
                    const titleEl = document.createElement("div");
                    titleEl.className =
                        "text-white font-bold text-sm mb-2 line-clamp-2 leading-snug";
                    titleEl.textContent = title;
                    bodyDiv.appendChild(titleEl);

                    // Store info
                    if (stores && stores.length > 0) {
                        const storeDiv = document.createElement("div");
                        storeDiv.className =
                            "pt-2 border-t border-slate-700/50 flex items-center justify-between gap-2";

                        const nearestStore = stores[0];
                        const infoDiv = document.createElement("div");
                        infoDiv.className = "flex-1 min-w-0";

                        const storeName = document.createElement("div");
                        // Highlight in yellow if it matches the selected store
                        const isSelectedStore =
                            selectedStore &&
                            nearestStore.storeName === selectedStore.storeName;
                        storeName.className = isSelectedStore
                            ? "text-yellow-400 font-semibold text-xs truncate"
                            : "text-green-400 font-semibold text-xs truncate";
                        storeName.textContent = nearestStore.storeName;
                        infoDiv.appendChild(storeName);

                        const distance = document.createElement("div");
                        distance.className = "text-gray-400 text-[10px] mt-0.5";
                        const miles = kmToMiles(nearestStore.distance);
                        distance.textContent = `${miles.toFixed(1)} mi â€¢ ${nearestStore.quantityOnHand} in stock`;
                        infoDiv.appendChild(distance);

                        storeDiv.appendChild(infoDiv);

                        if (stores.length > 1) {
                            const btn = document.createElement("button");
                            btn.className =
                                "px-2 py-1 bg-cyan-500/10 hover:bg-cyan-500/20 border border-cyan-500/30 hover:border-cyan-500 text-cyan-400 rounded-md text-[10px] font-semibold transition-all flex-shrink-0";
                            btn.textContent = `+${stores.length - 1}`;
                            btn.onclick = (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                showStoresModal(title, stores);
                            };
                            storeDiv.appendChild(btn);
                        }

                        bodyDiv.appendChild(storeDiv);
                    } else {
                        // Not in stock
                        const notInStock = document.createElement("div");
                        notInStock.className =
                            "pt-2 border-t border-slate-700/50 text-red-400 font-semibold text-xs text-center";
                        notInStock.textContent = "Not in stock";
                        bodyDiv.appendChild(notInStock);
                    }

                    card.appendChild(bodyDiv);
                    grid.appendChild(card);
                }
            }

            async function init() {
                await initStoreSelector();
                await loadProducts();

                // Hide loading overlay
                hideLoading();

                // Setup sort button
                const sortBtn = document.getElementById("sortBtn");
                sortBtn.addEventListener("click", async () => {
                    sortByDistance = !sortByDistance;

                    if (sortByDistance) {
                        sortBtn.textContent = "Default Order";
                        sortBtn.classList.add(
                            "bg-cyan-500/20",
                            "border-cyan-500",
                        );
                    } else {
                        sortBtn.textContent = "Sort by Distance";
                        sortBtn.classList.remove(
                            "bg-cyan-500/20",
                            "border-cyan-500",
                        );
                    }

                    await reloadProducts();
                });
            }

            init();
        </script>
    </body>
</html>
